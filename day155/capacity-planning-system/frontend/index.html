<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capacity Planning Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .status.healthy {
            background: #4caf50;
            color: white;
        }
        
        .status.error {
            background: #f44336;
            color: white;
        }
        
        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        
        .refresh-btn:hover {
            background: #5568d3;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .card h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .metric {
            margin: 10px 0;
        }
        
        .metric-label {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }
        
        .metric-value {
            color: #333;
            font-size: 24px;
            font-weight: bold;
        }
        
        .metric-value.zero {
            color: #f44336;
        }
        
        .metric-value.non-zero {
            color: #4caf50;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .forecast-chart {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .scale-events {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .scale-event {
            padding: 10px;
            margin: 5px 0;
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üöÄ Capacity Planning Dashboard</h1>
            <span id="status" class="status">Loading...</span>
            <button class="refresh-btn" onclick="loadDashboard()">üîÑ Refresh</button>
            <span id="lastUpdate" style="margin-left: 20px; color: #666;"></span>
        </header>
        
        <div id="loading" class="loading">Loading metrics...</div>
        <div id="error" class="error" style="display: none;"></div>
        
        <div id="dashboard" style="display: none;">
            <div class="grid">
                <div class="card">
                    <h2>üìä Current Metrics</h2>
                    <div id="currentMetrics"></div>
                </div>
                
                <div class="card">
                    <h2>üîÆ Forecast (7 days)</h2>
                    <div id="forecastMetrics"></div>
                </div>
                
                <div class="card">
                    <h2>üíª Capacity</h2>
                    <div id="capacityMetrics"></div>
                </div>
                
                <div class="card">
                    <h2>üìà Patterns</h2>
                    <div id="patternMetrics"></div>
                </div>
            </div>
            
            <div class="forecast-chart">
                <h2>üìã Capacity Recommendations</h2>
                <div id="recommendations"></div>
            </div>
        </div>
    </div>
    
    <script>
        // Auto-detect API base URL
        const API_BASE = (() => {
            // If running from Windows accessing WSL, try to detect
            const hostname = window.location.hostname;
            // If hostname is an IP (WSL IP), use it for API too
            if (hostname.match(/^\d+\.\d+\.\d+\.\d+$/)) {
                return `http://${hostname}:8000`;
            }
            // Otherwise use same hostname as dashboard
            const port = window.location.port;
            const protocol = window.location.protocol;
            const host = window.location.hostname;
            // If dashboard is on 3000, API should be on 8000 of same host
            return `${protocol}//${host}:8000`;
        })();
        
        console.log('API Base URL:', API_BASE);
        
        function safeNumber(value) {
            const num = typeof value === 'number' ? value : parseFloat(value);
            return isNaN(num) ? 0 : num;
        }
        
        function formatNumber(num) {
            const n = safeNumber(num);
            if (n >= 1000000) return (n / 1000000).toFixed(2) + 'M';
            if (n >= 1000) return (n / 1000).toFixed(2) + 'K';
            return n.toFixed(2);
        }
        
        function safeToFixed(value, decimals = 2) {
            const n = safeNumber(value);
            return n.toFixed(decimals);
        }
        
        function checkZero(value) {
            const n = safeNumber(value);
            return n === 0 || isNaN(n);
        }
        
        function createMetric(label, value, unit = '') {
            const isZero = checkZero(value);
            return `
                <div class="metric">
                    <div class="metric-label">${label}</div>
                    <div class="metric-value ${isZero ? 'zero' : 'non-zero'}">
                        ${isZero ? '‚ö†Ô∏è 0' : formatNumber(value)} ${unit}
                    </div>
                </div>
            `;
        }
        
        async function loadDashboard() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            
            try {
                // Health check
                const health = await fetch(`${API_BASE}/`).then(r => r.json());
                document.getElementById('status').textContent = health.status;
                document.getElementById('status').className = `status ${health.status === 'healthy' ? 'healthy' : 'error'}`;
                
                // Load all metrics
                const [current, forecast, capacity, patterns, recommendations, metrics] = await Promise.all([
                    fetch(`${API_BASE}/api/capacity/current`).then(r => r.json()),
                    fetch(`${API_BASE}/api/forecast/7days`).then(r => r.json()),
                    fetch(`${API_BASE}/api/capacity/current`).then(r => r.json()),
                    fetch(`${API_BASE}/api/patterns`).then(r => r.json()),
                    fetch(`${API_BASE}/api/capacity/recommendations`).then(r => r.json()),
                    fetch(`${API_BASE}/api/metrics/summary`).then(r => r.json())
                ]);
                
                // Display current metrics
                document.getElementById('currentMetrics').innerHTML = `
                    ${createMetric('Current Load', current.current_load_logs_per_second, 'logs/sec')}
                    ${createMetric('Nodes (Current)', current.nodes?.current, '')}
                    ${createMetric('Nodes (Required)', current.nodes?.required, '')}
                    ${createMetric('Utilization', safeToFixed((safeNumber(current.utilization) * 100), 1), '%')}
                    ${createMetric('CPU Cores', current.resources?.total_cpu_cores, '')}
                    ${createMetric('Memory', current.resources?.total_memory_gb, 'GB')}
                    ${createMetric('Disk', current.resources?.total_disk_gb, 'GB')}
                `;
                
                // Display forecast
                document.getElementById('forecastMetrics').innerHTML = `
                    ${createMetric('Current Load', forecast.current_logs_per_second, 'logs/sec')}
                    ${createMetric('Predicted (7d)', forecast.predicted_logs_per_second, 'logs/sec')}
                    ${createMetric('Growth', safeToFixed(forecast.growth_percentage, 1), '%')}
                    ${createMetric('Confidence', safeToFixed((safeNumber(forecast.confidence_level) * 100), 0), '%')}
                `;
                
                // Display capacity
                document.getElementById('capacityMetrics').innerHTML = `
                    ${createMetric('Current Nodes', capacity.nodes?.current, '')}
                    ${createMetric('Required Nodes', capacity.nodes?.required, '')}
                    ${createMetric('Nodes to Add', capacity.nodes?.to_add, '')}
                    ${createMetric('Capacity Utilization', safeToFixed((safeNumber(capacity.utilization) * 100), 1), '%')}
                `;
                
                // Display patterns
                document.getElementById('patternMetrics').innerHTML = `
                    ${createMetric('Trend Strength', safeToFixed((safeNumber(patterns.trend_strength) * 100), 1), '%')}
                    ${createMetric('Seasonal Strength', safeToFixed((safeNumber(patterns.seasonal_strength) * 100), 1), '%')}
                    ${createMetric('Growth Rate (Monthly)', safeToFixed((safeNumber(patterns.growth_rate_monthly) * 100), 2), '%')}
                    <div class="metric">
                        <div class="metric-label">Strong Trend</div>
                        <div class="metric-value ${patterns.has_strong_trend ? 'non-zero' : 'zero'}">
                            ${patterns.has_strong_trend ? '‚úÖ Yes' : '‚ùå No'}
                        </div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Strong Seasonality</div>
                        <div class="metric-value ${patterns.has_strong_seasonality ? 'non-zero' : 'zero'}">
                            ${patterns.has_strong_seasonality ? '‚úÖ Yes' : '‚ùå No'}
                        </div>
                    </div>
                `;
                
                // Display recommendations
                const recHtml = `
                    <div class="metric">
                        <div class="metric-label">Forecast Period</div>
                        <div class="metric-value non-zero">${recommendations.forecast_period}</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Current Capacity</div>
                        <div class="metric-value non-zero">${recommendations.current_capacity?.nodes || 0} nodes (${formatNumber(recommendations.current_capacity?.logs_per_second || 0)} logs/sec)</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Peak Requirement</div>
                        <div class="metric-value non-zero">Day ${recommendations.peak_requirement?.day || 'N/A'}: ${recommendations.peak_requirement?.nodes || 0} nodes (${formatNumber(recommendations.peak_requirement?.logs_per_second || 0)} logs/sec)</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Recommendation</div>
                        <div class="metric-value non-zero">${recommendations.recommendation}</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Current Monthly Cost</div>
                        <div class="metric-value non-zero">$${safeToFixed(recommendations.cost_projection?.current_monthly_usd, 2)}</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Projected Monthly Cost</div>
                        <div class="metric-value non-zero">$${safeToFixed(recommendations.cost_projection?.projected_monthly_usd, 2)}</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Additional Monthly Cost</div>
                        <div class="metric-value non-zero">$${safeToFixed(recommendations.cost_projection?.additional_monthly_usd, 2)}</div>
                    </div>
                    ${recommendations.scale_events && recommendations.scale_events.length > 0 ? `
                        <h3 style="margin-top: 20px;">üö® Scaling Events (${recommendations.scale_events.length})</h3>
                        <div class="scale-events">
                            ${recommendations.scale_events.slice(0, 10).map(event => `
                                <div class="scale-event">
                                    <strong>Day ${event.day || 'N/A'}:</strong> ${event.action || 'N/A'}<br>
                                    Load: ${formatNumber(event.predicted_load)} logs/sec, Utilization: ${safeToFixed((safeNumber(event.utilization) * 100), 1)}%
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                `;
                document.getElementById('recommendations').innerHTML = recHtml;
                
                // Update timestamp
                document.getElementById('lastUpdate').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                let errorMsg = `Error loading dashboard: ${error.message}`;
                
                // Log full error for debugging
                console.error('Dashboard error:', error);
                console.error('Error stack:', error.stack);
                
                // Provide helpful error messages
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    errorMsg += `<br><br>üí° Connection Tips:<br>`;
                    errorMsg += `1. Make sure the API server is running (port 8000)<br>`;
                    errorMsg += `2. If accessing from Windows, try using the WSL IP address instead of localhost<br>`;
                    errorMsg += `3. Check firewall settings<br>`;
                    errorMsg += `4. Run: wsl bash -c "cd /home/systemdr03/git/course/day155/capacity-planning-system && bash start.sh"`;
                } else if (error.message.includes('toFixed') || error.message.includes('is not a function')) {
                    errorMsg += `<br><br>üí° Data Format Error:<br>`;
                    errorMsg += `The API returned data in an unexpected format. Please check the browser console for details.<br>`;
                    errorMsg += `API Base URL: ${API_BASE}`;
                }
                
                document.getElementById('error').innerHTML = errorMsg;
                document.getElementById('status').textContent = 'error';
                document.getElementById('status').className = 'status error';
            }
        }
        
        // Load dashboard on page load
        loadDashboard();
        
        // Auto-refresh every 30 seconds
        setInterval(loadDashboard, 30000);
    </script>
</body>
</html>
